<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Paris 2024 | Modification de la session</title>
	<link rel="stylesheet" href="/jee-project/css/styles.css">
	<link rel="icon" href="/jee-project/img/paris.ico" type="image/x-icon">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.css" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/datepicker.min.js"></script>

</head>

<body class="body">
	<header>
		<nav class="bg-white dark:bg-gray-900 sticky w-full z-20 top-0 left-0 border-b border-gray-200 dark:border-gray-600">
			<div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
				<a class="flex items-center">
					<img id="paris_logo" src="/jee-project/img/paris2.png" class="h-16 mr-2" alt="Paris OG Logo">
					<span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">Paris 2024</span>
				</a>
				<div class="flex md:order-2">
				<button onclick="window.location.href='/jee-project/admin/index.html';" type="button"
						class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 text-center mr-3 md:mr-0 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Admin</button>
					<button data-collapse-toggle="navbar-sticky" type="button"
						class="inline-flex items-center p-2 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
						aria-controls="navbar-sticky" aria-expanded="false">
						<span class="sr-only">Open main menu</span>
						<svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"
							xmlns="http://www.w3.org/2000/svg">
							<path fill-rule="evenodd"
								d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
								clip-rule="evenodd"></path>
						</svg>
					</button>
				</div>
				<div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-sticky">
					<ul
						class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">

						<li>
							<a href="/jee-project/admin/discipline.html"
								class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 md:dark:hover:text-blue-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Disciplines</a>
						</li>
						<li>
							<a href="/jee-project/admin/site.html"
								class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 md:dark:hover:text-blue-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Sites</a>
						</li>
						<li>
							<a href="/jee-project/admin/session.html"
								class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 md:dark:hover:text-blue-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Sessions</a>
						</li>

					</ul>
				</div>
			</div>
		</nav>
	</header>

	<main style="margin-top: 10px" class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
	 
		<form id="modify-session-form" class="max-w-sm mx-auto">
		  <div class="mb-4">
		    <label class="block text-gray-700 font-bold mb-2" id="label_modify">
		      Session à modifier
		    </label>
		  </div>
				<div class="mb-4">

                    <div class="relative max-w-sm">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg aria-hidden="true" class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor"
                                viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                    d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <input datepicker type="text" id="session-date"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            placeholder="Select date" required>
                    </div>

                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2" for="session-fromhour">
                    </label>
                    <input
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        id="session-fromhour" type="text" placeholder="Heure de début (hh:mm)" required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2" for="session-tohour">
                    </label>
                    <input
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        id="session-tohour" type="text" placeholder="Heure de fin (hh:mm)" required>
                </div>

                <div class="mb-4">
                    <select
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        id="session-discipline" data-target="disciplineList">
                    </select>


                </div>
                
                 <div class="mb-4">
                <select
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                    id="session-site" data-target="siteList">
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2" for="session-tohour">
                </label>
                <input
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                    id="session-description" type="text" placeholder="Description" required>
            </div>

            <div class="mb-4">
                <select
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                    id="session-type" data-target="typeList">
                </select>

            </div>

            <div class="mb-4">
                <select
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                    id="session-categorie" data-target="categorieList">
                </select>
            </div>
		  <div class="flex items-center justify-center">
		    <button id="submit-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
		      Modifier
		    </button>
		  </div>
		</form>
    </main>
	
	<span class="dot" id="red"></span>
	<span class="dot" id="blue"></span>
	<span class="dot" id="yellow"></span>
	
	<script>
	  
	  const paris_logo = document.getElementById("paris_logo");
	  paris_logo.addEventListener("click", function(){
	  	window.location.href='/jee-project/';
	  });  
	
	  const form = document.getElementById('modify-session-form');
	  const dateInput = document.getElementById('session-date');
	  const fromHourInput = document.getElementById('session-fromhour');
	  const toHourInput = document.getElementById('session-tohour');
	  const descriptionInput = document.getElementById('session-description');

	  const disciplineInput = document.getElementById('session-discipline');
	  const siteInput = document.getElementById('session-site');
	  const typeInput = document.getElementById('session-type');
	  const categoryInput = document.getElementById('session-categorie');

	  const submitBtn = document.getElementById('submit-btn');

	  const selectDisciplineElement = document.getElementById('session-discipline');
	  const selectSiteElement = document.getElementById('session-site');
	  const selectTypeElement = document.getElementById('session-type');
	  const selectCategorieElement = document.getElementById('session-categorie');

	  /**========================================================
	   **                 generateOptions
	   *? Processes the site data and populates the table.
	   * @param {Array} options - The data to process.
	   * @param {} elements - Element in which we add the options
	   * @return {void}
	   **=========================================================**/
	  function generateOptions(options, element) {
	      options.forEach((option) => {
	          const optionElement = document.createElement('option');
	          optionElement.value = option;
	          optionElement.textContent = option;
	          element.appendChild(optionElement);
	      });
	  }

	  /**========================================================
	   **                 generateOptionsForDisciplines
	   *? Processes the site data and populates the table.
	   * @param {Array} options - The data to process.
	   * @param {} elements - Element in which we add the options
	   * @return {void}
	   **=========================================================**/
	  function generateOptionsForDisciplines(data, selectElement) {
	      // Clear existing options
	      selectElement.innerHTML = '';

	      // Generate options for disciplines
	      data.forEach((discipline) => {
	          const option = document.createElement('option');
	          option.value = discipline.name; // Use the appropriate property as the value
	          option.textContent = discipline.name; // Use the appropriate property as the label
	          selectElement.appendChild(option);
	      });
	  }
	  /**========================================================
	   **                 generateOptionsForSites
	   *? Processes the site data and populates the table.
	   * @param {Array} options - The data to process.
	   * @param {} elements - Element in which we add the options
	   * @return {void}
	   **=========================================================**/
	  function generateOptionsForSites(data, selectElement) {
	      // Clear existing options
	      selectElement.innerHTML = '';

	      // Generate options for sites
	      data.forEach((site) => {
	          const option = document.createElement('option');
	          option.value = site.id; // Use the appropriate property as the value
	          option.textContent = site.name; // Use the appropriate property as the label
	          selectElement.appendChild(option);
	      });
	  }
	   
	   function convertirDate(dateStr) {
		   const months = [
		     'jan', 'fév', 'mars', 'avr', 'mai', 'juin',
		     'juil', 'août', 'sept', 'oct', 'nov', 'déc'
		   ];

		   let mois = dateStr.split('.')[0];

		   mois = (months.findIndex(m => m === mois.toLowerCase()) + 1).toString();
		   mois = mois.length === 1 ? `0${mois}` : mois;

		   let day = dateStr.split(' ')[1].slice(0, -1);

		   day = day.length === 1 ? `0${day}` : day;

		   const year = dateStr.split(' ')[2];

		   return `${mois}/${day}/${year}`;
		}

	  fetch('/jee-project/api/session-controller/get-categories')
	      .then((response) => response.json())
	      .then((data) => {
	          generateOptions(data, selectCategorieElement);
	      })
	      .catch((error) => {
	          console.error('Une erreur s\'est produite lors de la récupération des catégories :', error);
	      });

	  fetch('/jee-project/api/session-controller/get-types')
	      .then((response) => response.json())
	      .then((data) => {
	          generateOptions(data, selectTypeElement);
	      })
	      .catch((error) => {
	          console.error('Une erreur s\'est produite lors de la récupération des catégories :', error);
	      });

	  fetch('/jee-project/api/discipline-controller/get-disciplines')
	      .then((response) => response.json())
	      .then((data) => {
	          generateOptionsForDisciplines(data, selectDisciplineElement);
	      })
	      .catch((error) => {
	          console.error('Une erreur s\'est produite lors de la récupération des catégories :', error);
	      });

	  fetch('/jee-project/api/site-controller/get-sites')
	      .then((response) => response.json())
	      .then((data) => {
	          generateOptionsForSites(data, selectSiteElement);
	      })
	      .catch((error) => {
	          console.error('Une erreur s\'est produite lors de la récupération des catégories :', error);
	      });
	  
	  const queryString = window.location.search;
	  const urlParams = new URLSearchParams(queryString);
      const sessionId = urlParams.get('id')
      
      document.getElementById("label_modify").textContent = "Session à modifier : " + sessionId;
	  
	  fetch('/jee-project/api/session-controller/get-sessions-code?code='+sessionId)
			.then((response) => response.json())
			.then((response) => {
				fromHourInput.value = response[0].fromHour;
				toHourInput.value = response[0].toHour;
				descriptionInput.value = response[0].description;
				dateInput.value = convertirDate(response[0].date);
		
				for (let i = 0; i < disciplineInput.options.length; i++) {
					   const option = disciplineInput.options[i];
					   if (option.value.trim() === response[0].discipline.name.trim()) {
					     		option.selected = true;
					     		break;
					   }
				}
				
				for (let i = 0; i < siteInput.options.length; i++) {
					   const option = siteInput.options[i];
					   if (option.id === response[0].site.id) {
					     		option.selected = true;
					     		break;
					   }
				}
				
				for (let i = 0; i < typeInput.options.length; i++) {
					   const option = typeInput.options[i];
					   if (option.value.trim() === response[0].type.trim()) {
					     		option.selected = true;
					     		break;
					   }
				}
				
				for (let i = 0; i < categoryInput.options.length; i++) {
					   const option = categoryInput.options[i];
					   if (option.value.trim() === response[0].category.trim()) {
					     		option.selected = true;
					     		break;
					   }
				}
				
	
			})
			.catch(error => console.log("Erreur : " + error));
	  
	  


	  submitBtn.addEventListener('click', function(event) {
		 	
		const date = dateInput.value;
		    
		if (date.trim() === '') {
		   alert("Vous devez renseigner une date");
		   return;
		}
		  	
		const fromHour = fromHourInput.value;
		    
		if (fromHour.trim() === '') {
		    alert("Vous devez renseigner une heure de début valide");
		    return;
		}
		  	
		const toHour = toHourInput.value;
		    
		if (toHour.trim() === '') {
		    alert("Vous devez renseigner une heure de fin valide");
		    return;
		}
		  	
		const discipline = disciplineInput.value;
		  
		var description = descriptionInput.value;
		    
		if (description.trim() === '') {
		    description = " "
		}
		  	
		const site = siteInput.value;
		const type = typeInput.value;
		const category = categoryInput.value;

	    const url = '/jee-project/api/session-controller/session-edit';
	    
	    const formData = new URLSearchParams();
	    formData.append('code', sessionId);
	    formData.append('date', date);
	    formData.append('fromHour', fromHour);
	    formData.append('toHour', toHour);
	    formData.append('discipline', discipline);
	    formData.append('site', site);
	    formData.append('description', description);
	    formData.append('type', type);
	    formData.append('category', category);

	    fetch(url, {
	        method: 'PUT',
	        headers: {
	            'Content-Type': 'application/x-www-form-urlencoded'
	          },
	          body: formData
	    })
	    .then(response => {
	    	if (response.status === 409) {
            	alert('Cette session chevauche une autre de la même discipline, ajout impossible')
            	throw new Error('Conflict timeline');
        	}
        	
        	if (response.status === 400) {
            	alert('Le format des heures doit respecter le format suivant hh:mm')
            	throw new Error('Conflict timeline');
        	}
        	
        	if (!response.ok) {
                throw new Error('Error network');
            }
	      return response.json();
	    })
	    .then(data => {
	      console.log('Session modifiée avec succès:', data);
	      form.reset();
	      const currentURL = window.location.href;
		  const projectUrl = currentURL.split("/jee-project")[0];
		  const newURL = projectUrl + "/jee-project/admin/session.html";
		  location.replace(newURL);
	    })
	    .catch(error => {
	      console.error('Erreur lors de l\'ajout de le site:', error);
	    });
	  });
	  
	</script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.js"></script>
	
</body>
</html>